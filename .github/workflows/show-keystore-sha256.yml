name: Show Keystore SHA-256 Fingerprints

on:
  workflow_dispatch:

jobs:
  show-fingerprints:
    name: Extract SHA-256 Fingerprints
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Decode keystores from secrets
        run: |
          echo "Decoding keystores from GitHub Secrets..."
          
          # Create directory
          mkdir -p android-keystores
          
          # Decode Default Theme keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android-keystores/expense-tracker-release.keystore
          
          # Decode Vibe Finance keystore
          echo "${{ secrets.KEYSTORE_BASE64_VIBE }}" | base64 -d > android-keystores/vibe-finance-release.keystore
          
          echo "âœ“ Keystores decoded successfully"

      - name: Extract SHA-256 Fingerprints
        run: |
          echo "=========================================="
          echo "SHA-256 Certificate Fingerprints"
          echo "=========================================="
          echo ""
          
          # Extract SHA-256 for Default Theme
          echo "DEFAULT THEME (com.expensetracker.app):"
          DEFAULT_SHA256=$(keytool -list -v \
            -keystore android-keystores/expense-tracker-release.keystore \
            -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
            -alias ${{ secrets.KEY_ALIAS }} | grep "SHA256:" | sed 's/.*SHA256: //')
          echo "$DEFAULT_SHA256"
          echo ""
          
          # Extract SHA-256 for Vibe Finance Theme
          echo "VIBE FINANCE THEME (com.vibefinance.app):"
          VIBE_SHA256=$(keytool -list -v \
            -keystore android-keystores/vibe-finance-release.keystore \
            -storepass "${{ secrets.KEYSTORE_PASSWORD_VIBE }}" \
            -alias ${{ secrets.KEY_ALIAS_VIBE }} | grep "SHA256:" | sed 's/.*SHA256: //')
          echo "$VIBE_SHA256"
          echo ""
          echo "=========================================="
          
          # Save to output for summary
          echo "default_sha256=$DEFAULT_SHA256" >> $GITHUB_ENV
          echo "vibe_sha256=$VIBE_SHA256" >> $GITHUB_ENV

      - name: Create Summary
        run: |
          echo "## ðŸ” SHA-256 Certificate Fingerprints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These fingerprints are needed for \`public/.well-known/assetlinks.json\` to enable Android App Links." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Default Theme (com.expensetracker.app)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.default_sha256 }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Vibe Finance Theme (com.vibefinance.app)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.vibe_sha256 }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ How to Use" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Copy the fingerprints above" >> $GITHUB_STEP_SUMMARY
          echo "2. Update \`public/.well-known/assetlinks.json\`:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo "[" >> $GITHUB_STEP_SUMMARY
          echo "  {" >> $GITHUB_STEP_SUMMARY
          echo "    \"relation\": [\"delegate_permission/common.handle_all_urls\"]," >> $GITHUB_STEP_SUMMARY
          echo "    \"target\": {" >> $GITHUB_STEP_SUMMARY
          echo "      \"namespace\": \"android_app\"," >> $GITHUB_STEP_SUMMARY
          echo "      \"package_name\": \"com.expensetracker.app\"," >> $GITHUB_STEP_SUMMARY
          echo "      \"sha256_cert_fingerprints\": [" >> $GITHUB_STEP_SUMMARY
          echo "        \"${{ env.default_sha256 }}\"" >> $GITHUB_STEP_SUMMARY
          echo "      ]" >> $GITHUB_STEP_SUMMARY
          echo "    }" >> $GITHUB_STEP_SUMMARY
          echo "  }," >> $GITHUB_STEP_SUMMARY
          echo "  {" >> $GITHUB_STEP_SUMMARY
          echo "    \"relation\": [\"delegate_permission/common.handle_all_urls\"]," >> $GITHUB_STEP_SUMMARY
          echo "    \"target\": {" >> $GITHUB_STEP_SUMMARY
          echo "      \"namespace\": \"android_app\"," >> $GITHUB_STEP_SUMMARY
          echo "      \"package_name\": \"com.vibefinance.app\"," >> $GITHUB_STEP_SUMMARY
          echo "      \"sha256_cert_fingerprints\": [" >> $GITHUB_STEP_SUMMARY
          echo "        \"${{ env.vibe_sha256 }}\"" >> $GITHUB_STEP_SUMMARY
          echo "      ]" >> $GITHUB_STEP_SUMMARY
          echo "    }" >> $GITHUB_STEP_SUMMARY
          echo "  }" >> $GITHUB_STEP_SUMMARY
          echo "]" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. Commit and deploy to Vercel" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify at: \`https://expense-tracker-io.vercel.app/.well-known/assetlinks.json\`" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        run: |
          # Remove keystores for security
          rm -rf android-keystores/
          echo "âœ“ Keystores cleaned up"
