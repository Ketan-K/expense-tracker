name: Generate Android Keystores

on:
  workflow_dispatch:
    inputs:
      keystore_password:
        description: 'Keystore Password (leave empty for auto-generated)'
        required: false
        type: string
      key_password:
        description: 'Key Password (leave empty for auto-generated)'
        required: false
        type: string

jobs:
  generate-keystores:
    name: Generate Keystores
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Generate secure passwords
        id: passwords
        run: |
          if [ -z "${{ github.event.inputs.keystore_password }}" ]; then
            DEFAULT_KEYSTORE_PASS=$(openssl rand -base64 16)
            DEFAULT_KEY_PASS=$(openssl rand -base64 16)
            VIBE_KEYSTORE_PASS=$(openssl rand -base64 16)
            VIBE_KEY_PASS=$(openssl rand -base64 16)
          else
            DEFAULT_KEYSTORE_PASS="${{ github.event.inputs.keystore_password }}"
            DEFAULT_KEY_PASS="${{ github.event.inputs.key_password }}"
            VIBE_KEYSTORE_PASS="${{ github.event.inputs.keystore_password }}"
            VIBE_KEY_PASS="${{ github.event.inputs.key_password }}"
          fi
          
          echo "default_keystore_pass=$DEFAULT_KEYSTORE_PASS" >> $GITHUB_OUTPUT
          echo "default_key_pass=$DEFAULT_KEY_PASS" >> $GITHUB_OUTPUT
          echo "vibe_keystore_pass=$VIBE_KEYSTORE_PASS" >> $GITHUB_OUTPUT
          echo "vibe_key_pass=$VIBE_KEY_PASS" >> $GITHUB_OUTPUT

      - name: Create keystores directory
        run: mkdir -p android-keystores

      - name: Generate Default Theme Keystore
        run: |
          # Using same password for both store and key for simplicity and reliability
          keytool -genkey -v \
            -keystore android-keystores/expense-tracker-release.keystore \
            -alias expense-tracker \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass "${{ steps.passwords.outputs.default_keystore_pass }}" \
            -keypass "${{ steps.passwords.outputs.default_keystore_pass }}" \
            -dname "CN=Expense Tracker, OU=Development, O=K-Tech Solutions, L=Pune, ST=Maharashtra, C=IN"

      - name: Generate Vibe Finance Theme Keystore
        run: |
          # Using same password for both store and key for simplicity and reliability
          keytool -genkey -v \
            -keystore android-keystores/vibe-finance-release.keystore \
            -alias vibe-finance \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass "${{ steps.passwords.outputs.vibe_keystore_pass }}" \
            -keypass "${{ steps.passwords.outputs.vibe_keystore_pass }}" \
            -dname "CN=Vibe Finance, OU=Development, O=K-Tech Solutions, L=Pune, ST=Maharashtra, C=IN"

      - name: Verify Default Keystore
        run: |
          echo "=== Verifying Default Theme Keystore ==="
          
          # List keystore to verify storepass
          if keytool -list -keystore android-keystores/expense-tracker-release.keystore \
              -storepass "${{ steps.passwords.outputs.default_keystore_pass }}" \
              -alias expense-tracker > /dev/null 2>&1; then
            echo "âœ“ Keystore password verified"
          else
            echo "âœ— Keystore password FAILED"
            exit 1
          fi
          
          # Test signing with jarsigner to verify keypass
          echo "Testing signing capability..."
          echo "TEST" > test.txt
          jar cf test.jar test.txt
          
          if jarsigner -keystore android-keystores/expense-tracker-release.keystore \
              -storepass "${{ steps.passwords.outputs.default_keystore_pass }}" \
              -keypass "${{ steps.passwords.outputs.default_keystore_pass }}" \
              test.jar expense-tracker > /dev/null 2>&1; then
            echo "âœ“ Key password verified - signing successful!"
          else
            echo "âœ— Key password FAILED - cannot sign"
            exit 1
          fi
          
          rm -f test.jar test.txt
          echo "âœ“âœ“âœ“ Default keystore fully verified!"

      - name: Verify Vibe Finance Keystore
        run: |
          echo "=== Verifying Vibe Finance Keystore ==="
          
          # List keystore to verify storepass
          if keytool -list -keystore android-keystores/vibe-finance-release.keystore \
              -storepass "${{ steps.passwords.outputs.vibe_keystore_pass }}" \
              -alias vibe-finance > /dev/null 2>&1; then
            echo "âœ“ Keystore password verified"
          else
            echo "âœ— Keystore password FAILED"
            exit 1
          fi
          
          # Test signing with jarsigner to verify keypass
          echo "Testing signing capability..."
          echo "TEST" > test.txt
          jar cf test.jar test.txt
          
          if jarsigner -keystore android-keystores/vibe-finance-release.keystore \
              -storepass "${{ steps.passwords.outputs.vibe_keystore_pass }}" \
              -keypass "${{ steps.passwords.outputs.vibe_keystore_pass }}" \
              test.jar vibe-finance > /dev/null 2>&1; then
            echo "âœ“ Key password verified - signing successful!"
          else
            echo "âœ— Key password FAILED - cannot sign"
            exit 1
          fi
          
          rm -f test.jar test.txt
          echo "âœ“âœ“âœ“ Vibe Finance keystore fully verified!"

      - name: Convert keystores to Base64
        id: base64
        run: |
          DEFAULT_BASE64=$(base64 -w 0 android-keystores/expense-tracker-release.keystore)
          VIBE_BASE64=$(base64 -w 0 android-keystores/vibe-finance-release.keystore)
          
          echo "default_base64<<EOF" >> $GITHUB_OUTPUT
          echo "$DEFAULT_BASE64" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "vibe_base64<<EOF" >> $GITHUB_OUTPUT
          echo "$VIBE_BASE64" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create credentials file
        run: |
          cat > android-keystores/KEYSTORE_CREDENTIALS.txt << EOL
          ================================================================================
          ANDROID KEYSTORE CREDENTIALS
          ================================================================================
          WARNING: KEEP THIS FILE SECURE AND DO NOT COMMIT TO GIT
          
          Generated on: $(date '+%Y-%m-%d %H:%M:%S')
          
          ================================================================================
          DEFAULT THEME (EXPENSE TRACKER)
          ================================================================================
          
          Keystore File: expense-tracker-release.keystore
          Key Alias: expense-tracker
          Keystore Password: ${{ steps.passwords.outputs.default_keystore_pass }}
          Key Password: ${{ steps.passwords.outputs.default_key_pass }}
          
          GitHub Secret: KEYSTORE_BASE64
          Value (Base64):
          ${{ steps.base64.outputs.default_base64 }}
          
          GitHub Secret: KEYSTORE_PASSWORD
          Value: ${{ steps.passwords.outputs.default_keystore_pass }}
          
          GitHub Secret: KEY_ALIAS
          Value: expense-tracker
          
          GitHub Secret: KEY_PASSWORD
          Value: ${{ steps.passwords.outputs.default_key_pass }}
          
          ================================================================================
          VIBE FINANCE THEME
          ================================================================================
          
          Keystore File: vibe-finance-release.keystore
          Key Alias: vibe-finance
          Keystore Password: ${{ steps.passwords.outputs.vibe_keystore_pass }}
          Key Password: ${{ steps.passwords.outputs.vibe_key_pass }}
          
          GitHub Secret: KEYSTORE_BASE64_VIBE
          Value (Base64):
          ${{ steps.base64.outputs.vibe_base64 }}
          
          GitHub Secret: KEYSTORE_PASSWORD_VIBE
          Value: ${{ steps.passwords.outputs.vibe_keystore_pass }}
          
          GitHub Secret: KEY_ALIAS_VIBE
          Value: vibe-finance
          
          GitHub Secret: KEY_PASSWORD_VIBE
          Value: ${{ steps.passwords.outputs.vibe_key_pass }}
          
          ================================================================================
          NEXT STEPS
          ================================================================================
          
          Step 1: Download the 'android-keystores' artifact from this workflow run
          
          Step 2: Go to GitHub repository - Settings - Secrets and variables - Actions
          
          Step 3: Add the following secrets (click 'New repository secret' for each):
          
             For Default Theme:
             - KEYSTORE_BASE64 (paste the Base64 value above)
             - KEYSTORE_PASSWORD (paste the password above)
             - KEY_ALIAS (paste: expense-tracker)
             - KEY_PASSWORD (paste the key password above)
          
             For Vibe Finance Theme:
             - KEYSTORE_BASE64_VIBE (paste the Base64 value above)
             - KEYSTORE_PASSWORD_VIBE (paste the password above)
             - KEY_ALIAS_VIBE (paste: vibe-finance)
             - KEY_PASSWORD_VIBE (paste the key password above)
          
          Step 4: Backup the downloaded keystores to a secure location
                  (password manager, encrypted drive, etc.)
          
          Step 5: Trigger a release build in GitHub Actions to test signing
          
          ================================================================================
          EOL

      - name: Upload keystores and credentials
        uses: actions/upload-artifact@v4
        with:
          name: android-keystores
          path: android-keystores/
          retention-days: 7

      - name: Summary
        run: |
          echo "## âœ… Keystores Generated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Download the Artifact" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to the **Artifacts** section at the bottom of this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Download **android-keystores.zip**" >> $GITHUB_STEP_SUMMARY
          echo "3. Extract the zip file" >> $GITHUB_STEP_SUMMARY
          echo "4. Open **KEYSTORE_CREDENTIALS.txt** for all passwords and Base64 values" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Add GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          echo "Copy the values from KEYSTORE_CREDENTIALS.txt to:" >> $GITHUB_STEP_SUMMARY
          echo "**Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Required secrets:" >> $GITHUB_STEP_SUMMARY
          echo "- \`KEYSTORE_BASE64\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`KEYSTORE_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`KEY_ALIAS\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`KEY_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`KEYSTORE_BASE64_VIBE\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`KEYSTORE_PASSWORD_VIBE\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`KEY_ALIAS_VIBE\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`KEY_PASSWORD_VIBE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Important" >> $GITHUB_STEP_SUMMARY
          echo "- Keep the keystores and credentials file secure" >> $GITHUB_STEP_SUMMARY
          echo "- Never commit them to Git" >> $GITHUB_STEP_SUMMARY
          echo "- Backup them in a secure location" >> $GITHUB_STEP_SUMMARY
          echo "- This artifact will be deleted after 7 days" >> $GITHUB_STEP_SUMMARY
